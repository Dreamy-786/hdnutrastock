<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Nutraceuticals ERP</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for React-like component feel -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b1a2e; /* Deep blue background */
            color: #e2e8f0; /* Light gray text */
        }
        .erp-card {
            background-color: #1a2b40; /* Darker blue card */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .nav-link {
            transition: all 0.2s;
        }
        .nav-link:hover {
            background-color: #2b3a50; /* Slightly lighter on hover */
        }
        .nav-link.active {
            background-color: #007bff; /* Tally-like blue accent */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.5);
        }
        input, select, textarea {
            background-color: #2b3a50;
            border: 1px solid #4a5c70;
            color: #e2e8f0;
        }
        .btn-primary {
            background-color: #007bff;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        /* Custom scrollbar for ERP feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a2b40; }
        ::-webkit-scrollbar-thumb { background: #4a5c70; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #5c7490; }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0b1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="h-screen flex flex-col">
        <!-- Application will be rendered here -->
    </div>

    <div id="loading-overlay" class="loading-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
        <div id="loading-message" class="text-lg text-blue-300">Connecting to Cloud Server...</div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE AND FIREBASE SETUP ---

        // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE
        // You MUST replace the content of this object with your actual
        // Firebase project configuration credentials from the Firebase Console.
        const firebaseConfig = {
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_AUTH_DOMAIN",
            // projectId: "YOUR_PROJECT_ID",
            // ... all other fields
        };

        let app, db, auth, userId = null;
        let state = {
            isLoggedIn: false,
            view: 'Dashboard',
            userName: '',
            isAuthReady: false,
            inventory: [],
            salesVouchers: [],
            purchaseVouchers: [],
            statusMessage: '',
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-hd-nutra-erp',
        };

        const ATEEQUE_USER = {
            username: 'Ateeque',
            password: 'admin123'
        };

        /**
         * Converts plain text to a unique, sanitized path slug.
         * @param {string} text 
         * @returns {string}
         */
        const slugify = (text) => {
            return text.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/[\s-]+/g, '-')
                .substring(0, 50);
        };

        /**
         * Base path for public collections shared across all users in this app.
         * @param {string} collectionName 
         * @returns {string}
         */
        const getPublicCollectionPath = (collectionName) => {
            return `artifacts/${state.appId}/public/data/${collectionName}`;
        };


        // --- CORE UI/RENDERING FUNCTIONS ---

        /**
         * Renders the current state to the DOM.
         */
        function render() {
            const appEl = document.getElementById('app');
            if (!appEl) return;

            if (!state.isAuthReady) {
                document.getElementById('loading-message').textContent = "Authenticating User...";
                return;
            }

            if (!state.isLoggedIn) {
                appEl.innerHTML = renderLoginScreen();
            } else {
                appEl.innerHTML = renderMainLayout();
            }

            // Re-initialize dynamic elements after rendering
            if (state.isLoggedIn) {
                setupEventListeners();
                renderContent(state.view);
                // Initialize Lucide icons
                lucide.createIcons();
            }
        }

        /**
         * Renders the application's main layout (Sidebar + Content).
         */
        function renderMainLayout() {
            return `
                <!-- Header -->
                <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center text-white">
                    <h1 class="text-xl font-bold tracking-wider text-blue-400">HD Nutraceuticals ERP</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium">User: ${state.userName} (${userId.substring(0, 8)}...)</span>
                        <button onclick="logout()" class="p-2 rounded-full bg-red-600 hover:bg-red-700 transition">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </header>

                <!-- Main Content Area -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Sidebar Navigation -->
                    <nav class="w-64 bg-gray-900 flex flex-col p-4 overflow-y-auto shadow-xl">
                        ${renderNavLink('Dashboard', 'LayoutDashboard')}
                        <div class="py-2 border-t border-gray-700 mt-2 mb-1">
                            <h3 class="text-xs text-gray-400 uppercase font-semibold ml-2">Transactions</h3>
                        </div>
                        ${renderNavLink('Sales', 'ShoppingCart')}
                        ${renderNavLink('Purchase', 'CreditCard')}
                        <div class="py-2 border-t border-gray-700 mt-2 mb-1">
                            <h3 class="text-xs text-gray-400 uppercase font-semibold ml-2">Masters & Reports</h3>
                        </div>
                        ${renderNavLink('Inventory', 'Boxes')}
                        ${renderNavLink('Reports', 'BookOpenText')}
                        <div class="mt-auto pt-4 border-t border-gray-700">
                            <p class="text-xs text-gray-500 p-2">App ID: ${state.appId}</p>
                        </div>
                    </nav>

                    <!-- Page Content -->
                    <main id="content-area" class="flex-1 p-6 overflow-y-auto bg-gray-800 transition-all duration-300"></main>
                </div>
            `;
        }

        /**
         * Helper function to render a single navigation link.
         * @param {string} viewName 
         * @param {string} iconName 
         * @returns {string}
         */
        function renderNavLink(viewName, iconName) {
            const isActive = state.view === viewName;
            return `
                <button 
                    onclick="setView('${viewName}')"
                    class="nav-link flex items-center p-3 rounded-lg text-sm font-medium my-1 transition duration-150 ease-in-out ${isActive ? 'active' : 'text-gray-300 hover:bg-gray-700'}"
                >
                    <i data-lucide="${iconName}" class="w-5 h-5 mr-3"></i>
                    ${viewName}
                </button>
            `;
        }

        /**
         * Renders the login screen UI.
         */
        function renderLoginScreen() {
            return `
                <div class="h-full flex items-center justify-center p-4">
                    <div class="erp-card p-8 rounded-xl w-full max-w-md">
                        <h2 class="text-3xl font-extrabold text-white text-center mb-6 border-b border-blue-600 pb-2">
                            HD Nutraceuticals ERP
                        </h2>
                        <h3 class="text-lg text-blue-400 text-center mb-8">
                            A simpler way to manage stock and accounts.
                        </h3>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium mb-2 text-gray-400">Username</label>
                                <input type="text" id="username" name="username" value="${ATEEQUE_USER.username}" required class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="username">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium mb-2 text-gray-400">Password</label>
                                <input type="password" id="password" name="password" value="${ATEEQUE_USER.password}" required class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="current-password">
                            </div>
                            <button type="submit" class="w-full btn-primary text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition duration-200">
                                Login
                            </button>
                        </form>
                        <p id="error-message" class="mt-4 text-center text-red-400 font-medium"></p>
                        <p class="mt-8 text-xs text-center text-gray-500">
                            Initial Access: **${ATEEQUE_USER.username}** / **${ATEEQUE_USER.password}**
                        </p>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the content for the currently selected view.
         * @param {string} view 
         */
        function renderContent(view) {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            contentArea.innerHTML = '';
            
            const title = document.createElement('h2');
            title.className = 'text-3xl font-bold mb-6 text-white border-b pb-2 border-gray-700';
            title.textContent = view;
            contentArea.appendChild(title);

            let html = '';

            switch (view) {
                case 'Dashboard':
                    html = renderDashboard();
                    break;
                case 'Sales':
                    html = renderSalesVoucher();
                    break;
                case 'Purchase':
                    html = renderPurchaseVoucher();
                    break;
                case 'Inventory':
                    html = renderInventory();
                    break;
                case 'Reports':
                    html = renderReports();
                    break;
                default:
                    html = '<p class="text-gray-400">View not found.</p>';
            }

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = html;
            contentArea.appendChild(contentDiv);
            
            // Re-attach specific form listeners
            if (view === 'Sales') {
                document.getElementById('sales-form')?.addEventListener('submit', handleSalesSubmit);
            }
            if (view === 'Purchase') {
                document.getElementById('purchase-form')?.addEventListener('submit', handlePurchaseSubmit);
            }
        }


        // --- VIEW RENDERING HELPERS ---

        function renderDashboard() {
            const totalInventoryValue = state.inventory.reduce((sum, item) => sum + (item.price * item.stock), 0).toFixed(2);
            const totalSales = state.salesVouchers.length;
            const totalPurchases = state.purchaseVouchers.length;

            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderStatCard('Total Inventory Items', state.inventory.length, 'Boxes', 'blue')}
                    ${renderStatCard('Total Inventory Value', `₹${formatNumber(totalInventoryValue)}`, 'DollarSign', 'green')}
                    ${renderStatCard('Total Sales Vouchers', totalSales, 'ShoppingCart', 'yellow')}
                    ${renderStatCard('Total Purchase Vouchers', totalPurchases, 'CreditCard', 'red')}
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-white">Recent Activity</h3>
                    <div class="erp-card p-4 rounded-lg">
                        <p class="text-gray-400">Activity logging and detailed reports will appear here.</p>
                        <ul class="list-disc list-inside text-sm text-gray-300 mt-3">
                            <li>Latest Sale: ${state.salesVouchers[0] ? state.salesVouchers[0].party : 'No sales yet'}</li>
                            <li>Latest Purchase: ${state.purchaseVouchers[0] ? state.purchaseVouchers[0].party : 'No purchases yet'}</li>
                            <li>Total Unique Products: ${state.inventory.length}</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderStatCard(title, value, icon, color) {
            return `
                <div class="erp-card p-6 rounded-xl flex items-center space-x-4">
                    <div class="p-3 rounded-full bg-${color}-600 text-white shadow-lg">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">${title}</p>
                        <p class="text-2xl font-extrabold text-white">${value}</p>
                    </div>
                </div>
            `;
        }

        function renderSalesVoucher() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="erp-card p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">New Sales Voucher</h3>
                            <form id="sales-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="salesVoucherNo" class="block text-sm font-medium text-gray-400">Voucher No.</label>
                                        <input type="text" id="salesVoucherNo" required class="w-full p-2 rounded-lg" value="S/${state.salesVouchers.length + 1}" readonly>
                                    </div>
                                    <div>
                                        <label for="salesDate" class="block text-sm font-medium text-gray-400">Date</label>
                                        <input type="date" id="salesDate" required class="w-full p-2 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                                    </div>
                                </div>
                                <div>
                                    <label for="salesParty" class="block text-sm font-medium text-gray-400">Party Name (Customer)</label>
                                    <input type="text" id="salesParty" required class="w-full p-2 rounded-lg" placeholder="e.g., ABC Retailers">
                                </div>

                                <!-- Item Selection (Simplified for V1) -->
                                <h4 class="text-lg font-semibold pt-4 text-white">Sale Item</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-1">
                                        <label for="salesItem" class="block text-sm font-medium text-gray-400">Product</label>
                                        <select id="salesItem" required class="w-full p-2 rounded-lg">
                                            <option value="">Select Item</option>
                                            ${state.inventory.map(item => `<option value="${item.name}">${item.name} (Stock: ${item.stock})</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="col-span-1">
                                        <label for="salesQuantity" class="block text-sm font-medium text-gray-400">Quantity</label>
                                        <input type="number" id="salesQuantity" required min="1" class="w-full p-2 rounded-lg" placeholder="Qty">
                                    </div>
                                    <div class="col-span-1">
                                        <label for="salesPrice" class="block text-sm font-medium text-gray-400">Rate</label>
                                        <input type="number" id="salesPrice" required min="0" step="0.01" class="w-full p-2 rounded-lg" placeholder="Price/unit">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-lg w-full">
                                    Save Sales Voucher
                                </button>
                                <p id="sales-status" class="mt-3 text-center text-sm font-medium"></p>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="erp-card p-4 rounded-xl">
                            <h3 class="text-lg font-semibold mb-3 text-white">Recent Sales</h3>
                            <ul class="space-y-2 text-sm">
                                ${state.salesVouchers.slice(0, 5).map(v => `
                                    <li class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                                        <span class="font-medium">${v.party}</span>
                                        <span class="text-sm text-green-400">₹${formatNumber(v.total)}</span>
                                    </li>
                                `).join('') || '<p class="text-gray-500">No recent sales.</p>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderPurchaseVoucher() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="erp-card p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4 text-blue-400">New Purchase Voucher</h3>
                            <form id="purchase-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="purchaseVoucherNo" class="block text-sm font-medium text-gray-400">Voucher No.</label>
                                        <input type="text" id="purchaseVoucherNo" required class="w-full p-2 rounded-lg" value="P/${state.purchaseVouchers.length + 1}" readonly>
                                    </div>
                                    <div>
                                        <label for="purchaseDate" class="block text-sm font-medium text-gray-400">Date</label>
                                        <input type="date" id="purchaseDate" required class="w-full p-2 rounded-lg" value="${new Date().toISOString().substring(0, 10)}">
                                    </div>
                                </div>
                                <div>
                                    <label for="purchaseParty" class="block text-sm font-medium text-gray-400">Party Name (Supplier)</label>
                                    <input type="text" id="purchaseParty" required class="w-full p-2 rounded-lg" placeholder="e.g., Supplier XYZ">
                                </div>

                                <!-- Item Selection (Simplified for V1) -->
                                <h4 class="text-lg font-semibold pt-4 text-white">Purchase Item</h4>
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="col-span-2">
                                        <label for="purchaseItemName" class="block text-sm font-medium text-gray-400">Product Name</label>
                                        <input type="text" id="purchaseItemName" required class="w-full p-2 rounded-lg" list="inventory-items-list" placeholder="Enter new or existing item">
                                        <datalist id="inventory-items-list">
                                            ${state.inventory.map(item => `<option value="${item.name}">`).join('')}
                                        </datalist>
                                    </div>
                                    <div class="col-span-1">
                                        <label for="purchaseQuantity" class="block text-sm font-medium text-gray-400">Quantity</label>
                                        <input type="number" id="purchaseQuantity" required min="1" class="w-full p-2 rounded-lg" placeholder="Qty">
                                    </div>
                                    <div class="col-span-1">
                                        <label for="purchasePrice" class="block text-sm font-medium text-gray-400">Rate</label>
                                        <input type="number" id="purchasePrice" required min="0" step="0.01" class="w-full p-2 rounded-lg" placeholder="Price/unit">
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-lg w-full">
                                    Save Purchase Voucher
                                </button>
                                <p id="purchase-status" class="mt-3 text-center text-sm font-medium"></p>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="erp-card p-4 rounded-xl">
                            <h3 class="text-lg font-semibold mb-3 text-white">Recent Purchases</h3>
                            <ul class="space-y-2 text-sm">
                                ${state.purchaseVouchers.slice(0, 5).map(v => `
                                    <li class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                                        <span class="font-medium">${v.party}</span>
                                        <span class="text-sm text-red-400">₹${formatNumber(v.total)}</span>
                                    </li>
                                `).join('') || '<p class="text-gray-500">No recent purchases.</p>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInventory() {
            if (state.inventory.length === 0) {
                return '<p class="text-gray-400">No inventory items found. Add items via Purchase Vouchers.</p>';
            }

            // Sort inventory by name
            const sortedInventory = [...state.inventory].sort((a, b) => a.name.localeCompare(b.name));

            return `
                <div class="erp-card p-6 rounded-xl overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Product Name</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Stock Qty</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Rate (Last Purchase)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Stock Value</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            ${sortedInventory.map(item => `
                                <tr class="hover:bg-gray-700 transition duration-150">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-white">${item.name}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-yellow-400">${item.stock}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-green-400">₹${formatNumber(item.price)}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-white">₹${formatNumber(item.price * item.stock)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderReports() {
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="erp-card p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white">Sales Ledger</h3>
                        <p class="text-gray-400">List of all Sales Vouchers (${state.salesVouchers.length}):</p>
                        <ul class="space-y-1 mt-3 text-sm text-gray-300 max-h-60 overflow-y-auto">
                            ${state.salesVouchers.map(v => `<li class="border-b border-gray-700 py-1">${v.vchNo} - ${v.party} - ₹${formatNumber(v.total)}</li>`).join('') || '<p class="text-gray-500">No Sales data.</p>'}
                        </ul>
                    </div>
                    <div class="erp-card p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white">Purchase Ledger</h3>
                        <p class="text-gray-400">List of all Purchase Vouchers (${state.purchaseVouchers.length}):</p>
                        <ul class="space-y-1 mt-3 text-sm text-gray-300 max-h-60 overflow-y-auto">
                            ${state.purchaseVouchers.map(v => `<li class="border-b border-gray-700 py-1">${v.vchNo} - ${v.party} - ₹${formatNumber(v.total)}</li>`).join('') || '<p class="text-gray-500">No Purchase data.</p>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        // --- AUTHENTICATION & INITIALIZATION ---

        /**
         * Sets up the initial Firebase connection and authentication.
         */
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use a custom token if available, otherwise sign in anonymously
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously for a persistent user ID for Firestore rules
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                state.isAuthReady = true;
                
                // If this is the first run on GitHub, state.isLoggedIn is false.
                // We leave it false so the user is forced to use the hardcoded credentials.
                
                document.getElementById('loading-overlay').classList.add('hidden');
                render();
                
                // Start listening to the public collections
                setupFirestoreListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-message').textContent = "Initialization Failed. Check Console for Firebase Config Error.";
                document.getElementById('loading-message').classList.add('text-red-500');
            }
        }
        
        /**
         * Attaches event listeners for the login screen.
         */
        function setupEventListeners() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        /**
         * Handles the login form submission.
         * @param {Event} event 
         */
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMessageEl = document.getElementById('error-message');

            if (username === ATEEQUE_USER.username && password === ATEEQUE_USER.password) {
                state.isLoggedIn = true;
                state.userName = ATEEQUE_USER.username;
                errorMessageEl.textContent = '';
                render();
            } else {
                errorMessageEl.textContent = 'Invalid Username or Password.';
            }
        }

        /**
         * Logs out the user and resets the state.
         */
        window.logout = function() {
            state.isLoggedIn = false;
            state.userName = '';
            state.view = 'Dashboard';
            render();
        }
        
        /**
         * Changes the current view and re-renders.
         * @param {string} view 
         */
        window.setView = function(view) {
            state.view = view;
            render(); // Re-render main layout to update active link
            renderContent(view); // Render new content
        }

        // --- FIREBASE DATA MANAGEMENT ---

        /**
         * Sets up real-time listeners for all public collections.
         */
        function setupFirestoreListeners() {
            if (!db || !state.isAuthReady) return;

            // 1. Inventory Listener
            onSnapshot(collection(db, getPublicCollectionPath('inventory_items')), (snapshot) => {
                state.inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Inventory updated:", state.inventory.length, "items");
                if (state.isLoggedIn) renderContent(state.view);
            }, (error) => {
                console.error("Error listening to inventory:", error);
            });

            // 2. Sales Vouchers Listener
            onSnapshot(collection(db, getPublicCollectionPath('sales_vouchers')), (snapshot) => {
                state.salesVouchers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.timestamp - a.timestamp); // Sort by newest
                console.log("Sales Vouchers updated:", state.salesVouchers.length, "vouchers");
                if (state.isLoggedIn) renderContent(state.view);
            }, (error) => {
                console.error("Error listening to sales vouchers:", error);
            });

            // 3. Purchase Vouchers Listener
            onSnapshot(collection(db, getPublicCollectionPath('purchase_vouchers')), (snapshot) => {
                state.purchaseVouchers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.timestamp - a.timestamp); // Sort by newest
                console.log("Purchase Vouchers updated:", state.purchaseVouchers.length, "vouchers");
                if (state.isLoggedIn) renderContent(state.view);
            }, (error) => {
                console.error("Error listening to purchase vouchers:", error);
            });
        }
        
        /**
         * Handles the submission of a new Sales Voucher.
         * @param {Event} event 
         */
        async function handleSalesSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const statusEl = document.getElementById('sales-status');
            statusEl.className = 'mt-3 text-center text-yellow-400 font-medium';
            statusEl.textContent = 'Processing Sale...';
            
            try {
                const itemEl = form.elements['salesItem'];
                const itemName = itemEl.value;
                const quantity = parseInt(form.elements['salesQuantity'].value);
                const price = parseFloat(form.elements['salesPrice'].value);
                
                if (!itemName || quantity <= 0 || price < 0) {
                    throw new Error("Invalid item, quantity, or price.");
                }

                // 1. Calculate total
                const total = quantity * price;

                // 2. Add Voucher to Sales Collection
                await addDoc(collection(db, getPublicCollectionPath('sales_vouchers')), {
                    vchNo: form.elements['salesVoucherNo'].value,
                    date: form.elements['salesDate'].value,
                    party: form.elements['salesParty'].value,
                    item: itemName,
                    quantity: quantity,
                    rate: price,
                    total: total,
                    timestamp: Date.now(),
                    userId: userId 
                });

                // 3. Update Inventory (Decrement Stock)
                const inventoryItem = state.inventory.find(item => item.name === itemName);
                if (inventoryItem) {
                    const newStock = inventoryItem.stock - quantity;
                    if (newStock < 0) {
                        // This would require better validation, but for now, we just log a warning
                        console.warn(`Warning: Stock for ${itemName} went negative (${newStock})!`);
                    }
                    const itemRef = doc(db, getPublicCollectionPath('inventory_items'), inventoryItem.id);
                    await updateDoc(itemRef, { stock: newStock });
                }
                
                form.reset();
                document.getElementById('salesDate').value = new Date().toISOString().substring(0, 10);
                statusEl.className = 'mt-3 text-center text-green-400 font-medium';
                statusEl.textContent = `Sales Voucher saved successfully! Total: ₹${formatNumber(total)}`;

            } catch (error) {
                console.error("Error saving sales voucher:", error);
                statusEl.className = 'mt-3 text-center text-red-400 font-medium';
                statusEl.textContent = `Error: ${error.message || 'Failed to save voucher.'}`;
            }
        }

        /**
         * Handles the submission of a new Purchase Voucher.
         * @param {Event} event 
         */
        async function handlePurchaseSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const statusEl = document.getElementById('purchase-status');
            statusEl.className = 'mt-3 text-center text-yellow-400 font-medium';
            statusEl.textContent = 'Processing Purchase...';

            try {
                const itemName = form.elements['purchaseItemName'].value.trim();
                const quantity = parseInt(form.elements['purchaseQuantity'].value);
                const price = parseFloat(form.elements['purchasePrice'].value);

                if (!itemName || quantity <= 0 || price < 0) {
                    throw new Error("Invalid item, quantity, or price.");
                }

                // 1. Calculate total
                const total = quantity * price;

                // 2. Add Voucher to Purchase Collection
                await addDoc(collection(db, getPublicCollectionPath('purchase_vouchers')), {
                    vchNo: form.elements['purchaseVoucherNo'].value,
                    date: form.elements['purchaseDate'].value,
                    party: form.elements['purchaseParty'].value,
                    item: itemName,
                    quantity: quantity,
                    rate: price,
                    total: total,
                    timestamp: Date.now(),
                    userId: userId 
                });

                // 3. Update or Create Inventory Item (Increment Stock & Update Rate)
                const existingItem = state.inventory.find(item => item.name.toLowerCase() === itemName.toLowerCase());

                if (existingItem) {
                    // Update existing item
                    const newStock = existingItem.stock + quantity;
                    const itemRef = doc(db, getPublicCollectionPath('inventory_items'), existingItem.id);
                    await updateDoc(itemRef, {
                        stock: newStock,
                        price: price, // Update rate to the latest purchase rate
                        updatedAt: Date.now()
                    });
                } else {
                    // Create new item
                    await addDoc(collection(db, getPublicCollectionPath('inventory_items')), {
                        name: itemName,
                        stock: quantity,
                        price: price,
                        createdAt: Date.now(),
                        userId: userId
                    });
                }
                
                form.reset();
                document.getElementById('purchaseDate').value = new Date().toISOString().substring(0, 10);
                statusEl.className = 'mt-3 text-center text-green-400 font-medium';
                statusEl.textContent = `Purchase Voucher saved and Inventory updated! Total: ₹${formatNumber(total)}`;

            } catch (error) {
                console.error("Error saving purchase voucher:", error);
                statusEl.className = 'mt-3 text-center text-red-400 font-medium';
                statusEl.textContent = `Error: ${error.message || 'Failed to save voucher.'}`;
            }
        }

        /**
         * Formats a number to Indian Rupees (INR) format.
         * @param {number} num 
         * @returns {string}
         */
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(num);
        }


        // Start the application when the window loads
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
