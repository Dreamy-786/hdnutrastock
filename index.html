<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Nutraceuticals ERP</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Tally-like Dark Blue Theme */
        :root {
            --primary-bg: #1e3a8a; /* Dark Blue */
            --secondary-bg: #374151; /* Dark Gray for panels */
            --text-light: #f3f4f6;
            --tally-green: #34d399; /* Green for success/accept */
            --tally-red: #f87171; /* Red for errors/cancel */
            --tally-border: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-bg);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .tally-panel {
            background-color: var(--primary-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        .tally-input {
            background-color: #0c1a3b; /* Slightly darker than primary-bg */
            border: 1px solid var(--tally-border);
            color: var(--text-light);
            border-radius: 4px;
            padding: 8px;
            transition: all 0.2s;
        }

        .tally-input:focus {
            outline: 2px solid var(--tally-green);
            border-color: var(--tally-green);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.3);
        }

        .tally-button {
            transition: all 0.2s;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background-color: var(--tally-green);
            color: var(--primary-bg);
        }

        .btn-primary:hover {
            background-color: #10b981;
        }
        
        .btn-secondary {
            background-color: var(--tally-red);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background-color: #ef4444;
        }

        .btn-icon {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-icon:hover {
            background-color: #4b5563;
        }

        /* Tally-style Menu */
        .tally-menu {
            background-color: #111827;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
        }
        .tally-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            transition: background-color 0.1s;
        }
        .tally-menu-item:hover {
            background-color: #1f2937;
        }
        .tally-menu-item.active {
            background-color: var(--primary-bg);
            font-weight: bold;
        }
    </style>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP STATE AND FIREBASE SETUP ---

        // YOUR ACTUAL FIREBASE CONFIGURATION CREDENTIALS ARE INSERTED BELOW:
        // This makes the app connect to your unique cloud database.
        const firebaseConfig = {
            apiKey: "AIzaSyAqwyPclIJl7aowmkXQJ9HZy5jBuCnYGmg",
            authDomain: "hd-nutraceuticals-erp.firebaseapp.com",
            projectId: "hd-nutraceuticals-erp",
            storageBucket: "hd-nutraceuticals-erp.firebasestorage.app",
            messagingSenderId: "965408530453",
            appId: "1:965408530453:web:04d7f8af7480a003176e1c",
            measurementId: "G-44DM120W8V" // Not used by the app logic but kept for completeness
        };

        let app, db, auth;
        // User map (hardcoded for initial Admin)
        const USER_MAP = {
            // Ateeque's initial setup is handled by the initial_auth_token logic
            'ateeque': { role: 'admin', password: 'admin123' },
            // Add other admins/executives here if you want to use the simple login
        };
        const ADMIN_USERNAME = 'ateeque'; // The hardcoded initial admin username
        const ADMIN_PASSWORD = 'admin123'; // The hardcoded initial admin password

        // Initial application state
        let state = {
            view: 'LOADING', // LOADING, LOGIN, DASHBOARD, INVENTORY, PARTIES, SALES_VOUCHER, PURCHASE_VOUCHER
            isAuthReady: false,
            isAuthenticated: false,
            user: { username: null, uid: null, role: null },
            inventory: [],
            parties: [],
            error: null,
            // Voucher States
            currentVoucher: {
                type: 'SALES', // or 'PURCHASE'
                partyId: '',
                items: [],
                totalAmount: 0,
                // Sales specific
                executiveName: null,
                voucherNumber: null,
            }
        };

        // --- CORE APPLICATION LOGIC ---

        const updateState = (newState) => {
            state = { ...state, ...newState };
            render();
            // console.log("State Updated:", state);
        };

        const generateVoucherNumber = (type, list) => {
            const prefix = type === 'SALES' ? 'SL' : 'PR';
            const year = new Date().getFullYear().toString().slice(-2);
            const currentCount = list.length + 1;
            return `${prefix}/${year}/${currentCount.toString().padStart(5, '0')}`;
        };

        // --- FIREBASE AUTHENTICATION ---

        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check auth state immediately
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in (either anonymously or via custom token)
                        const userRef = doc(db, "users", user.uid);
                        const userSnap = await getDoc(userRef);
                        
                        let userData;
                        if (userSnap.exists()) {
                            userData = userSnap.data();
                        } else {
                            // If user is new (e.g., first anonymous sign-in), create basic profile
                            userData = { username: ADMIN_USERNAME, role: 'admin' };
                            await setDoc(userRef, userData, { merge: true });
                        }

                        updateState({
                            isAuthReady: true,
                            isAuthenticated: true,
                            user: {
                                username: userData.username || ADMIN_USERNAME,
                                uid: user.uid,
                                role: userData.role || 'admin'
                            },
                            view: 'DASHBOARD'
                        });
                        setupDataListeners();
                    } else {
                        // Attempt silent sign-in (anonymous for initial security rules)
                        await signInAnonymously(auth);
                        // The onAuthStateChanged listener will handle the resulting sign-in
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                updateState({ view: 'LOGIN', error: `Connection Error: ${error.message}` });
            }
        };

        const handleLogin = async (username, password) => {
            username = username.toLowerCase();
            const userRef = doc(db, "users", auth.currentUser.uid);

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Admin Login: Update the anonymous user profile to reflect Admin role
                try {
                    await setDoc(userRef, { username: ADMIN_USERNAME, role: 'admin' }, { merge: true });
                    updateState({
                        isAuthenticated: true,
                        user: { username: ADMIN_USERNAME, uid: auth.currentUser.uid, role: 'admin' },
                        view: 'DASHBOARD',
                        error: null
                    });
                } catch (e) {
                    console.error("Login Failed:", e);
                    updateState({ error: `Login update failed: ${e.message}` });
                }
            } else {
                updateState({ error: 'Invalid Username or Password for Admin.' });
            }
        };

        // --- FIREBASE DATA LISTENERS ---

        const setupDataListeners = () => {
            if (!state.user.uid) return;

            // 1. Inventory Listener (Public Data)
            const inventoryPath = `/artifacts/${firebaseConfig.projectId}/public/data/inventory_items`;
            const inventoryQuery = query(collection(db, inventoryPath));
            onSnapshot(inventoryQuery, (snapshot) => {
                const inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateState({ inventory });
            }, (error) => console.error("Inventory Snapshot Error:", error));

            // 2. Parties (Customers/Suppliers) Listener (Public Data)
            const partiesPath = `/artifacts/${firebaseConfig.projectId}/public/data/parties`;
            const partiesQuery = query(collection(db, partiesPath));
            onSnapshot(partiesQuery, (snapshot) => {
                const parties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateState({ parties });
            }, (error) => console.error("Parties Snapshot Error:", error));

            // 3. Sales Voucher Listener (Public Data) - For reporting and audit
            const salesPath = `/artifacts/${firebaseConfig.projectId}/public/data/sales_vouchers`;
            const salesQuery = query(collection(db, salesPath));
            onSnapshot(salesQuery, (snapshot) => {
                const sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateState({ salesVouchers: sales });
            }, (error) => console.error("Sales Snapshot Error:", error));

            // 4. Purchase Voucher Listener (Public Data) - For reporting and audit
            const purchasePath = `/artifacts/${firebaseConfig.projectId}/public/data/purchase_vouchers`;
            const purchaseQuery = query(collection(db, purchasePath));
            onSnapshot(purchaseQuery, (snapshot) => {
                const purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateState({ purchaseVouchers: purchases });
            }, (error) => console.error("Purchase Snapshot Error:", error));
        };

        // --- DATA ENTRY FUNCTIONS (ADMIN/VOUCHER) ---

        const addUpdateInventoryItem = async (item) => {
            if (state.user.role !== 'admin') {
                updateState({ error: 'Permission denied. Only Admin can manage inventory.' });
                return;
            }
            if (!item.name || !item.barcode || isNaN(item.stock) || isNaN(item.sellingPrice) || isNaN(item.purchasePrice)) {
                updateState({ error: 'All inventory fields are required and must be valid numbers.' });
                return;
            }

            const path = `/artifacts/${firebaseConfig.projectId}/public/data/inventory_items`;
            const itemRef = item.id ? doc(db, path, item.id) : doc(collection(db, path));

            try {
                const data = {
                    name: item.name,
                    barcode: item.barcode.toUpperCase(),
                    stock: parseFloat(item.stock),
                    sellingPrice: parseFloat(item.sellingPrice),
                    purchasePrice: parseFloat(item.purchasePrice),
                    updatedAt: serverTimestamp(),
                };

                if (!item.id) {
                    data.createdAt = serverTimestamp();
                }

                await setDoc(itemRef, data, { merge: true });
                updateState({ error: null });
            } catch (e) {
                updateState({ error: `Inventory save failed: ${e.message}` });
            }
        };

        const addUpdateParty = async (party) => {
            if (!party.name || !party.type) {
                updateState({ error: 'Party name and type are required.' });
                return;
            }
            const path = `/artifacts/${firebaseConfig.projectId}/public/data/parties`;
            const partyRef = party.id ? doc(db, path, party.id) : doc(collection(db, path));

            try {
                const data = {
                    name: party.name,
                    type: party.type,
                    address: party.address || '',
                    phone: party.phone || '',
                    updatedAt: serverTimestamp(),
                };

                if (!party.id) {
                    data.createdAt = serverTimestamp();
                }

                await setDoc(partyRef, data, { merge: true });
                updateState({ error: null });
            } catch (e) {
                updateState({ error: `Party save failed: ${e.message}` });
            }
        };

        const recordVoucher = async (voucher) => {
            const isSales = voucher.type === 'SALES';
            const path = `/artifacts/${firebaseConfig.projectId}/public/data/${isSales ? 'sales_vouchers' : 'purchase_vouchers'}`;

            if (!voucher.partyId || voucher.items.length === 0) {
                updateState({ error: 'Voucher requires a party and at least one item.' });
                return;
            }
            
            // Get current count for voucher number generation (simple non-guaranteed method)
            const collectionSnap = await getDocs(collection(db, path));
            const voucherNumber = generateVoucherNumber(voucher.type, collectionSnap.docs);

            try {
                await runTransaction(db, async (transaction) => {
                    const voucherRef = doc(collection(db, path));
                    const newVoucher = {
                        ...voucher,
                        voucherNumber: voucherNumber,
                        recordedBy: state.user.username,
                        recordedById: auth.currentUser.uid,
                        createdAt: serverTimestamp(),
                    };
                    transaction.set(voucherRef, newVoucher);

                    // Update Inventory Stock within the transaction
                    for (const item of voucher.items) {
                        const itemRef = doc(db, `/artifacts/${firebaseConfig.projectId}/public/data/inventory_items`, item.itemId);
                        const itemSnap = await transaction.get(itemRef);

                        if (!itemSnap.exists()) {
                            throw new Error(`Item with ID ${item.itemId} not found.`);
                        }

                        const currentStock = itemSnap.data().stock || 0;
                        let newStock;

                        if (isSales) {
                            newStock = currentStock - item.quantity;
                            if (newStock < 0) {
                                throw new Error(`Insufficient stock for item: ${item.name}. Available: ${currentStock}`);
                            }
                        } else { // Purchase
                            newStock = currentStock + item.quantity;
                        }

                        transaction.update(itemRef, { stock: newStock });
                    }
                });

                updateState({ error: `Voucher ${voucherNumber} recorded successfully!`, currentVoucher: { type: voucher.type, partyId: '', items: [], totalAmount: 0 } });
            } catch (e) {
                updateState({ error: `Voucher transaction failed: ${e.message}` });
                console.error("Transaction failed: ", e);
            }
        };

        // --- RENDER FUNCTIONS ---

        const getCurrency = (amount) => `â‚¹ ${parseFloat(amount).toFixed(2)}`;

        const NavMenu = () => `
            <div class="tally-menu w-64 p-4 flex flex-col h-full">
                <h1 class="text-xl font-bold text-white mb-6 border-b border-gray-700 pb-2">HDN ERP</h1>
                
                <div class="mb-4">
                    <h2 class="text-xs text-gray-400 uppercase mb-1">Masters</h2>
                    <div class="tally-menu-item ${state.view === 'INVENTORY' ? 'active' : ''}" onclick="window.updateState({view: 'INVENTORY'})">
                        Inventory Master (I)
                    </div>
                    <div class="tally-menu-item ${state.view === 'PARTIES' ? 'active' : ''}" onclick="window.updateState({view: 'PARTIES'})">
                        Party Master (P)
                    </div>
                </div>

                <div class="mb-4">
                    <h2 class="text-xs text-gray-400 uppercase mb-1">Transactions</h2>
                    <div class="tally-menu-item ${state.view === 'SALES_VOUCHER' ? 'active' : ''}" onclick="window.updateState({view: 'SALES_VOUCHER', currentVoucher: { type: 'SALES', partyId: '', items: [], totalAmount: 0 }})">
                        Sales Voucher (F8)
                    </div>
                    <div class="tally-menu-item ${state.view === 'PURCHASE_VOUCHER' ? 'active' : ''}" onclick="window.updateState({view: 'PURCHASE_VOUCHER', currentVoucher: { type: 'PURCHASE', partyId: '', items: [], totalAmount: 0 }})">
                        Purchase Voucher (F9)
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-gray-700">
                    <div class="text-sm text-gray-300">User: ${state.user.username} (${state.user.role})</div>
                    <button onclick="window.updateState({view: 'LOGIN', isAuthenticated: false, user: { username: null, uid: null, role: null }})" 
                            class="w-full mt-2 btn-secondary">
                        Logout
                    </button>
                </div>
            </div>
        `;
        
        const Header = (title) => `
            <div class="p-4 bg-gray-700 flex justify-between items-center text-white rounded-t-lg shadow-md">
                <h1 class="text-2xl font-semibold">${title}</h1>
                <div class="text-sm">
                    Date: ${new Date().toLocaleDateString('en-IN')}
                </div>
            </div>
        `;

        const renderLogin = () => `
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="tally-panel w-full max-w-md p-8 space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-white">HD NUTRACEUTICALS ERP</h2>
                        <p class="mt-2 text-gray-300">Tally-Style Connected System</p>
                    </div>

                    ${state.error ? `<div class="p-3 bg-red-800 text-white rounded-md">${state.error}</div>` : ''}

                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="username" class="tally-input w-full mt-1" value="Ateeque" required>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="password" class="tally-input w-full mt-1" value="admin123" required>
                            <p class="text-xs text-gray-400 mt-1">Default Admin: Ateeque / admin123</p>
                        </div>
                        <button onclick="window.handleLogin(document.getElementById('username').value, document.getElementById('password').value)"
                                class="w-full btn-primary text-lg">
                            Login
                        </button>
                    </div>
                </div>
            </div>
        `;

        const renderDashboard = () => `
            <div class="flex-1 p-8">
                ${Header('Dashboard')}
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Cards will go here -->
                    <div class="tally-panel p-6 bg-blue-900">
                        <h3 class="text-xl font-semibold mb-2">Total Inventory Value</h3>
                        <p class="text-3xl font-bold text-tally-green">${getCurrency(state.inventory.reduce((sum, item) => sum + (item.stock * item.sellingPrice), 0))}</p>
                    </div>
                    <div class="tally-panel p-6 bg-red-900">
                        <h3 class="text-xl font-semibold mb-2">Unique Products</h3>
                        <p class="text-3xl font-bold">${state.inventory.length}</p>
                    </div>
                    <div class="tally-panel p-6 bg-green-900">
                        <h3 class="text-xl font-semibold mb-2">Sales Vouchers</h3>
                        <p class="text-3xl font-bold">${state.salesVouchers ? state.salesVouchers.length : 0}</p>
                    </div>
                </div>
            </div>
        `;

        const renderInventoryMaster = () => {
            if (state.user.role !== 'admin') return '<div class="p-8 text-red-500">Access Denied. Only Admin can view Inventory Master.</div>';
            
            const tableRows = state.inventory.map(item => `
                <tr class="hover:bg-gray-700 cursor-pointer" onclick="window.openInventoryModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <td class="p-3">${item.name}</td>
                    <td class="p-3">${item.barcode}</td>
                    <td class="p-3 text-right">${item.stock.toFixed(0)}</td>
                    <td class="p-3 text-right">${getCurrency(item.sellingPrice)}</td>
                    <td class="p-3 text-right">${getCurrency(item.purchasePrice)}</td>
                </tr>
            `).join('');

            return `
                <div class="flex-1 p-8">
                    ${Header('Inventory Master (Stock Items)')}
                    ${state.error ? `<div class="mt-4 p-3 bg-red-800 text-white rounded-md">${state.error}</div>` : ''}

                    <div class="mt-4 flex justify-end">
                        <button onclick="window.openInventoryModal()" class="btn-primary tally-button">
                            + Create New Item
                        </button>
                    </div>

                    <div class="mt-4 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-3">Item Name</th>
                                    <th class="p-3">Barcode</th>
                                    <th class="p-3 text-right">Stock</th>
                                    <th class="p-3 text-right">Selling Price</th>
                                    <th class="p-3 text-right">Purchase Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="5" class="p-4 text-center text-gray-400">No items found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                ${renderInventoryModal()}
            `;
        };

        const renderInventoryModal = () => {
            const item = state.modalData || {};
            const isEdit = !!item.id;
            
            return `
                <div id="inventoryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${state.modalData ? '' : 'hidden'}">
                    <div class="tally-panel w-full max-w-lg p-6 space-y-4">
                        <h3 class="text-2xl font-bold border-b pb-2">${isEdit ? 'Edit Stock Item' : 'Create New Stock Item'}</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Item Name</label>
                            <input type="text" id="itemName" class="tally-input w-full mt-1" value="${item.name || ''}" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Barcode / SKU</label>
                            <input type="text" id="itemBarcode" class="tally-input w-full mt-1" value="${item.barcode || ''}" required>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Initial Stock</label>
                                <input type="number" id="itemStock" class="tally-input w-full mt-1" value="${item.stock || 0}" ${isEdit ? 'disabled' : ''} required>
                                ${isEdit ? '<p class="text-xs text-yellow-300 mt-1">Stock is managed via Vouchers (Purchase/Sale).</p>' : ''}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Selling Price (â‚¹)</label>
                                <input type="number" id="itemSellingPrice" class="tally-input w-full mt-1" value="${item.sellingPrice || 0}" step="0.01" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Purchase Price (â‚¹)</label>
                                <input type="number" id="itemPurchasePrice" class="tally-input w-full mt-1" value="${item.purchasePrice || 0}" step="0.01" required>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4">
                            <button onclick="window.closeInventoryModal()" class="btn-secondary tally-button">
                                Cancel (Esc)
                            </button>
                            <button onclick="window.saveInventoryItem()" class="btn-primary tally-button">
                                ${isEdit ? 'Update Item' : 'Save Item'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- MODAL CONTROLS (for Inventory & Parties) ---
        
        window.openInventoryModal = (item = null) => {
            updateState({ modalData: item });
        };

        window.closeInventoryModal = () => {
            updateState({ modalData: null });
        };

        window.saveInventoryItem = () => {
            const item = {
                id: state.modalData?.id,
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                stock: document.getElementById('itemStock').value,
                sellingPrice: document.getElementById('itemSellingPrice').value,
                purchasePrice: document.getElementById('itemPurchasePrice').value,
            };
            window.addUpdateInventoryItem(item);
            window.closeInventoryModal();
        };

        // --- PARTY MASTER ---
        
        const renderPartyMaster = () => {
            if (state.user.role !== 'admin') return '<div class="p-8 text-red-500">Access Denied. Only Admin can view Party Master.</div>';

            const tableRows = state.parties.map(party => `
                <tr class="hover:bg-gray-700 cursor-pointer" onclick="window.openPartyModal(${JSON.stringify(party).replace(/"/g, '&quot;')})">
                    <td class="p-3">${party.name}</td>
                    <td class="p-3">${party.type}</td>
                    <td class="p-3">${party.phone || '-'}</td>
                    <td class="p-3">${party.address || '-'}</td>
                </tr>
            `).join('');

            return `
                <div class="flex-1 p-8">
                    ${Header('Party Master (Customers/Suppliers)')}
                    ${state.error ? `<div class="mt-4 p-3 bg-red-800 text-white rounded-md">${state.error}</div>` : ''}

                    <div class="mt-4 flex justify-end">
                        <button onclick="window.openPartyModal()" class="btn-primary tally-button">
                            + Create New Party
                        </button>
                    </div>

                    <div class="mt-4 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-3">Party Name</th>
                                    <th class="p-3">Type</th>
                                    <th class="p-3">Phone</th>
                                    <th class="p-3">Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="4" class="p-4 text-center text-gray-400">No parties found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                ${renderPartyModal()}
            `;
        };

        const renderPartyModal = () => {
            const party = state.modalData || {};
            const isEdit = !!party.id;
            
            return `
                <div id="partyModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${state.modalData ? '' : 'hidden'}">
                    <div class="tally-panel w-full max-w-lg p-6 space-y-4">
                        <h3 class="text-2xl font-bold border-b pb-2">${isEdit ? 'Edit Party' : 'Create New Party'}</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Party Name</label>
                            <input type="text" id="partyName" class="tally-input w-full mt-1" value="${party.name || ''}" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Party Type</label>
                            <select id="partyType" class="tally-input w-full mt-1" required>
                                <option value="Customer" ${party.type === 'Customer' ? 'selected' : ''}>Customer</option>
                                <option value="Supplier" ${party.type === 'Supplier' ? 'selected' : ''}>Supplier</option>
                                <option value="Both" ${party.type === 'Both' ? 'selected' : ''}>Both</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Phone</label>
                            <input type="text" id="partyPhone" class="tally-input w-full mt-1" value="${party.phone || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300">Address</label>
                            <textarea id="partyAddress" class="tally-input w-full mt-1">${party.address || ''}</textarea>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4">
                            <button onclick="window.closePartyModal()" class="btn-secondary tally-button">
                                Cancel (Esc)
                            </button>
                            <button onclick="window.saveParty()" class="btn-primary tally-button">
                                ${isEdit ? 'Update Party' : 'Save Party'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        window.openPartyModal = (party = null) => {
            updateState({ modalData: party });
        };

        window.closePartyModal = () => {
            updateState({ modalData: null });
        };

        window.saveParty = () => {
            const party = {
                id: state.modalData?.id,
                name: document.getElementById('partyName').value,
                type: document.getElementById('partyType').value,
                phone: document.getElementById('partyPhone').value,
                address: document.getElementById('partyAddress').value,
            };
            window.addUpdateParty(party);
            window.closePartyModal();
        };

        // --- VOUCHER ENTRY ---

        const renderVoucherEntry = (type) => {
            const isSales = type === 'SALES';
            const title = isSales ? 'Sales Voucher Entry' : 'Purchase Voucher Entry';
            const buttonText = isSales ? 'Record Sale' : 'Record Purchase';
            const partyTypeFilter = isSales ? 'Customer' : 'Supplier';
            
            const filteredParties = state.parties.filter(p => p.type === partyTypeFilter || p.type === 'Both');

            const itemRows = state.currentVoucher.items.map((item, index) => `
                <tr class="border-b border-gray-700">
                    <td class="p-2">${index + 1}</td>
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.barcode}</td>
                    <td class="p-2 text-right">
                        <input type="number" value="${item.quantity}" min="1" onchange="window.updateVoucherItemQuantity(${index}, event.target.value)" class="tally-input w-20 text-right">
                    </td>
                    <td class="p-2 text-right">${getCurrency(item.price)}</td>
                    <td class="p-2 text-right">${getCurrency(item.price * item.quantity)}</td>
                    <td class="p-2">
                        <button onclick="window.removeVoucherItem(${index})" class="btn-secondary px-2 py-1 text-xs">X</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="flex-1 p-8">
                    ${Header(title)}
                    ${state.error ? `<div class="mt-4 p-3 bg-red-800 text-white rounded-md">${state.error}</div>` : ''}

                    <!-- Header/Party Details -->
                    <div class="mt-4 tally-panel p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Voucher Number</label>
                                <p class="text-lg font-bold">${state.currentVoucher.voucherNumber || generateVoucherNumber(type, state.salesVouchers || [])}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Party Name (${partyTypeFilter})</label>
                                <select id="voucherPartyId" onchange="window.updateCurrentVoucherParty(event.target.value)" class="tally-input w-full mt-1">
                                    <option value="">-- Select Party --</option>
                                    ${filteredParties.map(p => `<option value="${p.id}" ${state.currentVoucher.partyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Item Entry Section -->
                    <div class="mt-6 tally-panel p-4">
                        <h3 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Item Details</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="barcodeInput" placeholder="Scan Barcode / Enter Manually" 
                                   onkeydown="window.handleBarcodeInput(event, '${type}')" 
                                   class="tally-input flex-1">
                            <button onclick="document.getElementById('cameraInput').click()" class="btn-icon tally-button">
                                ðŸ“¸ Scan with Camera (Mobile)
                            </button>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" 
                                   onchange="window.handleCameraScan(event, '${type}')">
                        </div>
                    </div>

                    <!-- Voucher Items Table -->
                    <div class="mt-6 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-2 w-10">No.</th>
                                    <th class="p-2">Item Name</th>
                                    <th class="p-2">Barcode</th>
                                    <th class="p-2 text-right w-24">Qty</th>
                                    <th class="p-2 text-right">Rate</th>
                                    <th class="p-2 text-right">Amount</th>
                                    <th class="p-2 w-12">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemRows}
                            </tbody>
                            <tfoot class="bg-gray-700 font-bold">
                                <tr>
                                    <td colspan="5" class="p-2 text-right">GRAND TOTAL:</td>
                                    <td class="p-2 text-right">${getCurrency(state.currentVoucher.totalAmount)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Footer/Action Buttons -->
                    <div class="mt-6 flex justify-end space-x-4">
                        <button onclick="window.updateState({view: 'DASHBOARD'})" class="btn-secondary tally-button">
                            Cancel (Esc)
                        </button>
                        <button onclick="window.confirmVoucherRecord('${type}')" class="btn-primary tally-button">
                            ${buttonText} (Save)
                        </button>
                    </div>
                </div>
            `;
        };

        window.updateCurrentVoucherParty = (partyId) => {
            window.updateState({ currentVoucher: { ...state.currentVoucher, partyId: partyId } });
        };

        window.handleBarcodeInput = (event, type) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = event.target.value.toUpperCase();
                event.target.value = ''; // Clear input immediately
                window.addItemToVoucher(barcode, type);
            }
        };

        window.handleCameraScan = (event, type) => {
            const file = event.target.files[0];
            if (file) {
                // Mock decoder: Assume the barcode is the first 8 digits in the filename (typical for testing)
                const filename = file.name.toUpperCase();
                const mockBarcodeMatch = filename.match(/\d{8}/);
                const mockBarcode = mockBarcodeMatch ? mockBarcodeMatch[0] : null;

                if (mockBarcode) {
                    window.addItemToVoucher(mockBarcode, type);
                } else {
                    updateState({ error: "Mock scanner failed. Please manually enter the barcode." });
                }
            }
        };

        window.addItemToVoucher = (barcode, type) => {
            const item = state.inventory.find(i => i.barcode === barcode);

            if (!item) {
                updateState({ error: `Barcode ${barcode} not found in Inventory.` });
                return;
            }

            const existingIndex = state.currentVoucher.items.findIndex(i => i.barcode === barcode);
            
            const priceKey = type === 'SALES' ? 'sellingPrice' : 'purchasePrice';

            if (existingIndex >= 0) {
                // Increment quantity if item already exists
                const newItems = [...state.currentVoucher.items];
                newItems[existingIndex].quantity += 1;
                
                const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
                window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
            } else {
                // Add new item
                const newItem = {
                    itemId: item.id,
                    name: item.name,
                    barcode: item.barcode,
                    quantity: 1,
                    price: item[priceKey],
                };
                
                const newItems = [...state.currentVoucher.items, newItem];
                const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
                window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
            }
            updateState({ error: null });
        };

        window.updateVoucherItemQuantity = (index, newQty) => {
            newQty = parseInt(newQty) || 0;
            if (newQty <= 0) return;

            const newItems = [...state.currentVoucher.items];
            newItems[index].quantity = newQty;

            const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
        };

        window.removeVoucherItem = (index) => {
            const newItems = state.currentVoucher.items.filter((_, i) => i !== index);
            const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
        };

        window.confirmVoucherRecord = (type) => {
            if (!state.currentVoucher.partyId) {
                updateState({ error: 'Please select a Party before recording the voucher.' });
                return;
            }
            if (state.currentVoucher.items.length === 0) {
                updateState({ error: 'Voucher cannot be empty.' });
                return;
            }

            const partyName = state.parties.find(p => p.id === state.currentVoucher.partyId)?.name;
            const confirmMessage = `Are you sure you want to record this ${type} voucher for Party: ${partyName} with a total of ${getCurrency(state.currentVoucher.totalAmount)}? This will update stock.`;

            // Use a simple modal for confirmation (cannot use window.confirm)
            if (window.confirm(confirmMessage)) {
                window.recordVoucher({ 
                    ...state.currentVoucher, 
                    type: type,
                    executiveName: state.user.username,
                    totalAmount: state.currentVoucher.totalAmount, // Ensure total is current
                });
            }
        };

        // --- MAIN RENDER LOOP ---

        const render = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            if (state.view === 'LOADING' && !state.isAuthReady) {
                appContainer.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center text-xl text-white">
                        Connecting to Cloud Server...
                    </div>
                `;
                return;
            }

            if (state.view === 'LOGIN' || !state.isAuthenticated) {
                appContainer.innerHTML = renderLogin();
                return;
            }

            // Main ERP Layout
            let content;
            switch (state.view) {
                case 'DASHBOARD':
                    content = renderDashboard();
                    break;
                case 'INVENTORY':
                    content = renderInventoryMaster();
                    break;
                case 'PARTIES':
                    content = renderPartyMaster();
                    break;
                case 'SALES_VOUCHER':
                    content = renderVoucherEntry('SALES');
                    break;
                case 'PURCHASE_VOUCHER':
                    content = renderVoucherEntry('PURCHASE');
                    break;
                default:
                    content = renderDashboard();
            }

            appContainer.innerHTML = `
                <div class="flex min-h-screen">
                    ${NavMenu()}
                    <div class="flex-1 overflow-auto">
                        ${content}
                    </div>
                </div>
            `;
        };

        // Expose functions globally for HTML event handlers
        window.updateState = updateState;
        window.handleLogin = handleLogin;
        window.openInventoryModal = openInventoryModal;
        window.closeInventoryModal = closeInventoryModal;
        window.saveInventoryItem = saveInventoryItem;
        window.addUpdateInventoryItem = addUpdateInventoryItem;
        window.openPartyModal = openPartyModal;
        window.closePartyModal = closePartyModal;
        window.saveParty = saveParty;
        window.addUpdateParty = addUpdateParty;
        window.handleBarcodeInput = handleBarcodeInput;
        window.handleCameraScan = handleCameraScan;
        window.addItemToVoucher = addItemToVoucher;
        window.updateVoucherItemQuantity = updateVoucherItemQuantity;
        window.removeVoucherItem = removeVoucherItem;
        window.confirmVoucherRecord = confirmVoucherRecord;
        window.recordVoucher = recordVoucher;

        // Initialize App on load
        window.onload = initializeFirebase;

        // Initial render
        render();

    </script>
</head>
<body>
    <!-- Main container for the single-page application -->
    <div id="app-container">
        <!-- Content will be injected here by JavaScript -->
    </div>
</body>
</html>
