<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Nutraceuticals ERP</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Tally-like Dark Blue Theme */
        :root {
            --primary-bg: #1e3a8a; /* Dark Blue */
            --secondary-bg: #374151; /* Dark Gray for panels */
            --text-light: #f3f4f6;
            --tally-green: #34d399; /* Green for success/accept */
            --tally-red: #f87171; /* Red for errors/cancel */
            --tally-border: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-bg);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .tally-panel {
            background-color: var(--primary-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        .tally-input {
            background-color: #0c1a3b; /* Slightly darker than primary-bg */
            border: 1px solid var(--tally-border);
            color: var(--text-light);
            border-radius: 4px;
            padding: 8px;
            transition: all 0.2s;
        }

        .tally-input:focus {
            outline: 2px solid var(--tally-green);
            border-color: var(--tally-green);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.3);
        }

        .tally-button {
            transition: all 0.2s;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background-color: var(--tally-green);
            color: var(--primary-bg);
        }

        .btn-primary:hover {
            background-color: #10b981;
        }
        
        .btn-secondary {
            background-color: var(--tally-red);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background-color: #ef4444;
        }

        .btn-icon {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-icon:hover {
            background-color: #4b5563;
        }

        /* Tally-style Menu */
        .tally-menu {
            background-color: #111827;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
        }
        .tally-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            transition: background-color 0.1s;
        }
        .tally-menu-item:hover {
            background-color: #1f2937;
        }
        .tally-menu-item.active {
            background-color: var(--primary-bg);
            font-weight: bold;
        }
    </style>

    <script>
        // --- GLOBAL APP STATE AND LOCAL STORAGE SETUP ---

        // Local Storage Keys
        const LS_INVENTORY = 'hderp_inventory';
        const LS_PARTIES = 'hderp_parties';
        const LS_SALES = 'hderp_sales';
        const LS_PURCHASES = 'hderp_purchases';

        // Initial application state
        let state = {
            view: 'DASHBOARD', // We start logged in since there is no server auth
            isAuthenticated: true,
            user: { username: 'Ateeque', role: 'admin' }, // Hardcoded user for simplicity
            inventory: [],
            parties: [],
            salesVouchers: [],
            purchaseVouchers: [],
            error: null,
            modalData: null, // For modal editing
            
            // Voucher States
            currentVoucher: {
                type: 'SALES', 
                partyId: '',
                items: [],
                totalAmount: 0,
            }
        };

        // --- LOCAL STORAGE FUNCTIONS ---

        const loadData = () => {
            try {
                state.inventory = JSON.parse(localStorage.getItem(LS_INVENTORY)) || [];
                state.parties = JSON.parse(localStorage.getItem(LS_PARTIES)) || [];
                state.salesVouchers = JSON.parse(localStorage.getItem(LS_SALES)) || [];
                state.purchaseVouchers = JSON.parse(localStorage.getItem(LS_PURCHASES)) || [];
            } catch (e) {
                console.error("Error loading from local storage:", e);
                state.error = "Error loading data. Data may be corrupt.";
            }
        };

        const saveData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                updateState({ error: null });
            } catch (e) {
                console.error("Error saving to local storage:", e);
                updateState({ error: `Error saving ${key.replace('hderp_', '')} data. Is storage full?` });
            }
        };

        // --- CORE APPLICATION LOGIC ---

        const updateState = (newState) => {
            state = { ...state, ...newState };
            render();
            // console.log("State Updated:", state);
        };

        const generateUniqueId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        };

        const generateVoucherNumber = (type, list) => {
            const prefix = type === 'SALES' ? 'SL' : 'PR';
            const year = new Date().getFullYear().toString().slice(-2);
            const currentCount = list.length + 1;
            return `${prefix}/${year}/${currentCount.toString().padStart(5, '0')}`;
        };

        // --- INVENTORY MANAGEMENT ---

        const addUpdateInventoryItem = (item) => {
            if (!item.name || !item.barcode || isNaN(item.stock) || isNaN(item.sellingPrice) || isNaN(item.purchasePrice)) {
                updateState({ error: 'All inventory fields are required and must be valid numbers.' });
                return;
            }

            const parsedItem = {
                name: item.name,
                barcode: item.barcode.toUpperCase(),
                stock: parseFloat(item.stock),
                sellingPrice: parseFloat(item.sellingPrice),
                purchasePrice: parseFloat(item.purchasePrice),
            };

            if (item.id) {
                // Update existing item
                const index = state.inventory.findIndex(i => i.id === item.id);
                if (index !== -1) {
                    state.inventory[index] = { ...state.inventory[index], ...parsedItem };
                }
            } else {
                // Add new item
                state.inventory.push({ ...parsedItem, id: generateUniqueId() });
            }

            saveData(LS_INVENTORY, state.inventory);
            updateState({ inventory: state.inventory, error: "Inventory updated successfully." });
        };

        // --- PARTY MANAGEMENT ---
        
        const addUpdateParty = (party) => {
            if (!party.name || !party.type) {
                updateState({ error: 'Party name and type are required.' });
                return;
            }
            
            const newParty = {
                name: party.name,
                type: party.type,
                address: party.address || '',
                phone: party.phone || '',
            };

            if (party.id) {
                // Update existing item
                const index = state.parties.findIndex(p => p.id === party.id);
                if (index !== -1) {
                    state.parties[index] = { ...state.parties[index], ...newParty };
                }
            } else {
                // Add new item
                state.parties.push({ ...newParty, id: generateUniqueId() });
            }
            
            saveData(LS_PARTIES, state.parties);
            updateState({ parties: state.parties, error: "Party updated successfully." });
        };

        // --- VOUCHER RECORDING ---

        const recordVoucher = (voucher) => {
            const isSales = voucher.type === 'SALES';
            const voucherListKey = isSales ? LS_SALES : LS_PURCHASES;
            let currentList = isSales ? state.salesVouchers : state.purchaseVouchers;
            
            if (!voucher.partyId || voucher.items.length === 0) {
                updateState({ error: 'Voucher requires a party and at least one item.' });
                return;
            }

            const inventoryCopy = [...state.inventory];
            let error = null;

            // 1. Check stock and prepare new inventory state
            for (const item of voucher.items) {
                const invIndex = inventoryCopy.findIndex(i => i.id === item.itemId);
                if (invIndex === -1) {
                    error = `Item ID ${item.itemId} not found.`;
                    break;
                }
                
                let newStock;
                if (isSales) {
                    newStock = inventoryCopy[invIndex].stock - item.quantity;
                    if (newStock < 0) {
                        error = `Insufficient stock for item: ${item.name}. Available: ${inventoryCopy[invIndex].stock}`;
                        break;
                    }
                } else { // Purchase
                    newStock = inventoryCopy[invIndex].stock + item.quantity;
                }
                
                inventoryCopy[invIndex].stock = newStock;
            }

            if (error) {
                updateState({ error });
                return;
            }
            
            // 2. Record Voucher
            const newVoucher = {
                ...voucher,
                id: generateUniqueId(),
                voucherNumber: generateVoucherNumber(voucher.type, currentList),
                recordedBy: state.user.username,
                createdAt: new Date().toISOString(),
            };

            currentList.push(newVoucher);
            
            // 3. Save all changes
            saveData(voucherListKey, currentList);
            saveData(LS_INVENTORY, inventoryCopy);

            updateState({ 
                inventory: inventoryCopy, 
                salesVouchers: isSales ? currentList : state.salesVouchers,
                purchaseVouchers: !isSales ? currentList : state.purchaseVouchers,
                error: `Voucher ${newVoucher.voucherNumber} recorded successfully!`, 
                currentVoucher: { type: voucher.type, partyId: '', items: [], totalAmount: 0 } 
            });
        };

        // --- RENDER HELPERS ---

        const getCurrency = (amount) => `â‚¹ ${parseFloat(amount).toFixed(2)}`;

        const NavMenu = () => `
            <div class="tally-menu w-64 p-4 flex flex-col h-full">
                <h1 class="text-xl font-bold text-white mb-6 border-b border-gray-700 pb-2">HDN ERP</h1>
                
                <div class="mb-4">
                    <h2 class="text-xs text-gray-400 uppercase mb-1">Navigation</h2>
                    <div class="tally-menu-item ${state.view === 'DASHBOARD' ? 'active' : ''}" onclick="window.updateState({view: 'DASHBOARD'})">
                        Dashboard
                    </div>
                </div>

                <div class="mb-4">
                    <h2 class="text-xs text-gray-400 uppercase mb-1">Masters</h2>
                    <div class="tally-menu-item ${state.view === 'INVENTORY' ? 'active' : ''}" onclick="window.updateState({view: 'INVENTORY'})">
                        Inventory Master (I)
                    </div>
                    <div class="tally-menu-item ${state.view === 'PARTIES' ? 'active' : ''}" onclick="window.updateState({view: 'PARTIES'})">
                        Party Master (P)
                    </div>
                </div>

                <div class="mb-4">
                    <h2 class="text-xs text-gray-400 uppercase mb-1">Transactions</h2>
                    <div class="tally-menu-item ${state.view === 'SALES_VOUCHER' ? 'active' : ''}" onclick="window.updateState({view: 'SALES_VOUCHER', currentVoucher: { type: 'SALES', partyId: '', items: [], totalAmount: 0 }})">
                        Sales Voucher (F8)
                    </div>
                    <div class="tally-menu-item ${state.view === 'PURCHASE_VOUCHER' ? 'active' : ''}" onclick="window.updateState({view: 'PURCHASE_VOUCHER', currentVoucher: { type: 'PURCHASE', partyId: '', items: [], totalAmount: 0 }})">
                        Purchase Voucher (F9)
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-gray-700">
                    <div class="text-sm text-gray-300">User: ${state.user.username} (${state.user.role})</div>
                    <p class="text-xs text-yellow-400 mt-1">Data saved only in this browser.</p>
                </div>
            </div>
        `;
        
        const Header = (title) => `
            <div class="p-4 bg-gray-700 flex justify-between items-center text-white rounded-t-lg shadow-md">
                <h1 class="text-2xl font-semibold">${title}</h1>
                <div class="text-sm">
                    Date: ${new Date().toLocaleDateString('en-IN')}
                </div>
            </div>
        `;

        const renderDashboard = () => `
            <div class="flex-1 p-8">
                ${Header('Dashboard')}
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Cards will go here -->
                    <div class="tally-panel p-6 bg-blue-900">
                        <h3 class="text-xl font-semibold mb-2">Total Inventory Value (Selling)</h3>
                        <p class="text-3xl font-bold text-tally-green">${getCurrency(state.inventory.reduce((sum, item) => sum + (item.stock * item.sellingPrice), 0))}</p>
                    </div>
                    <div class="tally-panel p-6 bg-red-900">
                        <h3 class="text-xl font-semibold mb-2">Unique Products</h3>
                        <p class="text-3xl font-bold">${state.inventory.length}</p>
                    </div>
                    <div class="tally-panel p-6 bg-green-900">
                        <h3 class="text-xl font-semibold mb-2">Sales Vouchers</h3>
                        <p class="text-3xl font-bold">${state.salesVouchers.length}</p>
                    </div>
                </div>
                ${state.error ? `<div class="mt-4 p-3 bg-green-800 text-white rounded-md">${state.error}</div>` : ''}
                <div class="mt-8 text-yellow-300 p-4 border border-yellow-500 rounded-md">
                    <p class="font-bold">IMPORTANT:</p>
                    <p>This version uses Local Storage. All data is saved ONLY on this specific browser and device. Clearing browser data will delete all ERP records.</p>
                </div>
            </div>
        `;

        // --- MODAL CONTROLS (for Inventory & Parties) ---
        
        window.openInventoryModal = (item = null) => {
            updateState({ modalData: item });
        };

        window.closeInventoryModal = () => {
            updateState({ modalData: null });
        };

        window.saveInventoryItem = () => {
            const item = {
                id: state.modalData?.id,
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                stock: document.getElementById('itemStock').value,
                sellingPrice: document.getElementById('itemSellingPrice').value,
                purchasePrice: document.getElementById('itemPurchasePrice').value,
            };
            window.addUpdateInventoryItem(item);
            window.closeInventoryModal();
        };
        
        window.openPartyModal = (party = null) => {
            updateState({ modalData: party });
        };

        window.closePartyModal = () => {
            updateState({ modalData: null });
        };

        window.saveParty = () => {
            const party = {
                id: state.modalData?.id,
                name: document.getElementById('partyName').value,
                type: document.getElementById('partyType').value,
                phone: document.getElementById('partyPhone').value,
                address: document.getElementById('partyAddress').value,
            };
            window.addUpdateParty(party);
            window.closePartyModal();
        };

        // --- INVENTORY MASTER RENDER ---

        const renderInventoryMaster = () => {
            const tableRows = state.inventory.map(item => `
                <tr class="hover:bg-gray-700 cursor-pointer" onclick="window.openInventoryModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <td class="p-3">${item.name}</td>
                    <td class="p-3">${item.barcode}</td>
                    <td class="p-3 text-right">${item.stock.toFixed(0)}</td>
                    <td class="p-3 text-right">${getCurrency(item.sellingPrice)}</td>
                    <td class="p-3 text-right">${getCurrency(item.purchasePrice)}</td>
                </tr>
            `).join('');

            const renderModal = () => {
                const item = state.modalData || {};
                const isEdit = !!item.id;
                
                return `
                    <div id="inventoryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${state.modalData ? '' : 'hidden'}">
                        <div class="tally-panel w-full max-w-lg p-6 space-y-4">
                            <h3 class="text-2xl font-bold border-b pb-2">${isEdit ? 'Edit Stock Item' : 'Create New Stock Item'}</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Item Name</label>
                                <input type="text" id="itemName" class="tally-input w-full mt-1" value="${item.name || ''}" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Barcode / SKU</label>
                                <input type="text" id="itemBarcode" class="tally-input w-full mt-1" value="${item.barcode || ''}" required>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300">Initial Stock</label>
                                    <input type="number" id="itemStock" class="tally-input w-full mt-1" value="${item.stock || 0}" ${isEdit ? 'disabled' : ''} required>
                                    ${isEdit ? '<p class="text-xs text-yellow-300 mt-1">Stock is managed via Vouchers (Purchase/Sale).</p>' : ''}
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300">Selling Price (â‚¹)</label>
                                    <input type="number" id="itemSellingPrice" class="tally-input w-full mt-1" value="${item.sellingPrice || 0}" step="0.01" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300">Purchase Price (â‚¹)</label>
                                    <input type="number" id="itemPurchasePrice" class="tally-input w-full mt-1" value="${item.purchasePrice || 0}" step="0.01" required>
                                </div>
                            </div>

                            <div class="flex justify-end space-x-4 pt-4">
                                <button onclick="window.closeInventoryModal()" class="btn-secondary tally-button">
                                    Cancel (Esc)
                                </button>
                                <button onclick="window.saveInventoryItem()" class="btn-primary tally-button">
                                    ${isEdit ? 'Update Item' : 'Save Item'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

            return `
                <div class="flex-1 p-8">
                    ${Header('Inventory Master (Stock Items)')}
                    ${state.error ? `<div class="mt-4 p-3 bg-green-800 text-white rounded-md">${state.error}</div>` : ''}

                    <div class="mt-4 flex justify-end">
                        <button onclick="window.openInventoryModal()" class="btn-primary tally-button">
                            + Create New Item
                        </button>
                    </div>

                    <div class="mt-4 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-3">Item Name</th>
                                    <th class="p-3">Barcode</th>
                                    <th class="p-3 text-right">Stock</th>
                                    <th class="p-3 text-right">Selling Price</th>
                                    <th class="p-3 text-right">Purchase Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="5" class="p-4 text-center text-gray-400">No items found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                ${renderModal()}
            `;
        };

        // --- PARTY MASTER RENDER ---

        const renderPartyMaster = () => {
            const tableRows = state.parties.map(party => `
                <tr class="hover:bg-gray-700 cursor-pointer" onclick="window.openPartyModal(${JSON.stringify(party).replace(/"/g, '&quot;')})">
                    <td class="p-3">${party.name}</td>
                    <td class="p-3">${party.type}</td>
                    <td class="p-3">${party.phone || '-'}</td>
                    <td class="p-3">${party.address || '-'}</td>
                </tr>
            `).join('');

            const renderModal = () => {
                const party = state.modalData || {};
                const isEdit = !!party.id;
                
                return `
                    <div id="partyModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${state.modalData ? '' : 'hidden'}">
                        <div class="tally-panel w-full max-w-lg p-6 space-y-4">
                            <h3 class="text-2xl font-bold border-b pb-2">${isEdit ? 'Edit Party' : 'Create New Party'}</h3>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Party Name</label>
                                <input type="text" id="partyName" class="tally-input w-full mt-1" value="${party.name || ''}" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Party Type</label>
                                <select id="partyType" class="tally-input w-full mt-1" required>
                                    <option value="Customer" ${party.type === 'Customer' ? 'selected' : ''}>Customer</option>
                                    <option value="Supplier" ${party.type === 'Supplier' ? 'selected' : ''}>Supplier</option>
                                    <option value="Both" ${party.type === 'Both' ? 'selected' : ''}>Both</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Phone</label>
                                <input type="text" id="partyPhone" class="tally-input w-full mt-1" value="${party.phone || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Address</label>
                                <textarea id="partyAddress" class="tally-input w-full mt-1">${party.address || ''}</textarea>
                            </div>

                            <div class="flex justify-end space-x-4 pt-4">
                                <button onclick="window.closePartyModal()" class="btn-secondary tally-button">
                                    Cancel (Esc)
                                </button>
                                <button onclick="window.saveParty()" class="btn-primary tally-button">
                                    ${isEdit ? 'Update Party' : 'Save Party'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

            return `
                <div class="flex-1 p-8">
                    ${Header('Party Master (Customers/Suppliers)')}
                    ${state.error ? `<div class="mt-4 p-3 bg-green-800 text-white rounded-md">${state.error}</div>` : ''}

                    <div class="mt-4 flex justify-end">
                        <button onclick="window.openPartyModal()" class="btn-primary tally-button">
                            + Create New Party
                        </button>
                    </div>

                    <div class="mt-4 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-3">Party Name</th>
                                    <th class="p-3">Type</th>
                                    <th class="p-3">Phone</th>
                                    <th class="p-3">Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="4" class="p-4 text-center text-gray-400">No parties found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
                ${renderModal()}
            `;
        };
        
        // --- VOUCHER ENTRY ---

        const renderVoucherEntry = (type) => {
            const isSales = type === 'SALES';
            const title = isSales ? 'Sales Voucher Entry' : 'Purchase Voucher Entry';
            const buttonText = isSales ? 'Record Sale' : 'Record Purchase';
            const partyTypeFilter = isSales ? 'Customer' : 'Supplier';
            
            const filteredParties = state.parties.filter(p => p.type === partyTypeFilter || p.type === 'Both');

            const itemRows = state.currentVoucher.items.map((item, index) => `
                <tr class="border-b border-gray-700">
                    <td class="p-2">${index + 1}</td>
                    <td class="p-2">${item.name}</td>
                    <td class="p-2">${item.barcode}</td>
                    <td class="p-2 text-right">
                        <input type="number" value="${item.quantity}" min="1" onchange="window.updateVoucherItemQuantity(${index}, event.target.value)" class="tally-input w-20 text-right">
                    </td>
                    <td class="p-2 text-right">${getCurrency(item.price)}</td>
                    <td class="p-2 text-right">${getCurrency(item.price * item.quantity)}</td>
                    <td class="p-2">
                        <button onclick="window.removeVoucherItem(${index})" class="btn-secondary px-2 py-1 text-xs">X</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="flex-1 p-8">
                    ${Header(title)}
                    ${state.error ? `<div class="mt-4 p-3 ${state.error.includes('successfully') ? 'bg-green-800' : 'bg-red-800'} text-white rounded-md">${state.error}</div>` : ''}

                    <!-- Header/Party Details -->
                    <div class="mt-4 tally-panel p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Voucher Number</label>
                                <p class="text-lg font-bold">${generateVoucherNumber(type, isSales ? state.salesVouchers : state.purchaseVouchers)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Party Name (${partyTypeFilter})</label>
                                <select id="voucherPartyId" onchange="window.updateCurrentVoucherParty(event.target.value)" class="tally-input w-full mt-1">
                                    <option value="">-- Select Party --</option>
                                    ${filteredParties.map(p => `<option value="${p.id}" ${state.currentVoucher.partyId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Item Entry Section -->
                    <div class="mt-6 tally-panel p-4">
                        <h3 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Item Details</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="barcodeInput" placeholder="Scan Barcode / Enter Manually" 
                                   onkeydown="window.handleBarcodeInput(event, '${type}')" 
                                   class="tally-input flex-1">
                            <button onclick="window.showConfirmationModal('scan')" class="btn-icon tally-button">
                                ðŸ“¸ Scan with Camera (Mobile Mock)
                            </button>
                        </div>
                    </div>

                    <!-- Voucher Items Table -->
                    <div class="mt-6 tally-panel p-0 overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-2 w-10">No.</th>
                                    <th class="p-2">Item Name</th>
                                    <th class="p-2">Barcode</th>
                                    <th class="p-2 text-right w-24">Qty</th>
                                    <th class="p-2 text-right">Rate</th>
                                    <th class="p-2 text-right">Amount</th>
                                    <th class="p-2 w-12">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemRows}
                            </tbody>
                            <tfoot class="bg-gray-700 font-bold">
                                <tr>
                                    <td colspan="5" class="p-2 text-right">GRAND TOTAL:</td>
                                    <td class="p-2 text-right">${getCurrency(state.currentVoucher.totalAmount)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Footer/Action Buttons -->
                    <div class="mt-6 flex justify-end space-x-4">
                        <button onclick="window.updateState({view: 'DASHBOARD'})" class="btn-secondary tally-button">
                            Cancel (Esc)
                        </button>
                        <button onclick="window.showConfirmationModal('record', '${type}')" class="btn-primary tally-button">
                            ${buttonText} (Save)
                        </button>
                    </div>
                </div>
                ${renderConfirmationModal()}
            `;
        };

        window.updateCurrentVoucherParty = (partyId) => {
            const newVoucher = { ...state.currentVoucher, partyId: partyId };
            window.updateState({ currentVoucher: newVoucher });
        };

        window.handleBarcodeInput = (event, type) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = event.target.value.toUpperCase().trim();
                event.target.value = ''; // Clear input immediately
                window.addItemToVoucher(barcode, type);
            }
        };

        window.addItemToVoucher = (barcode, type) => {
            const item = state.inventory.find(i => i.barcode === barcode);

            if (!item) {
                updateState({ error: `Barcode ${barcode} not found in Inventory.` });
                return;
            }

            const existingIndex = state.currentVoucher.items.findIndex(i => i.barcode === barcode);
            
            const priceKey = type === 'SALES' ? 'sellingPrice' : 'purchasePrice';
            const currentItems = [...state.currentVoucher.items];

            if (existingIndex >= 0) {
                // Increment quantity if item already exists
                currentItems[existingIndex].quantity += 1;
            } else {
                // Add new item
                const newItem = {
                    itemId: item.id,
                    name: item.name,
                    barcode: item.barcode,
                    quantity: 1,
                    price: item[priceKey],
                };
                currentItems.push(newItem);
            }
            
            const totalAmount = currentItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            window.updateState({ 
                currentVoucher: { ...state.currentVoucher, items: currentItems, totalAmount },
                error: null 
            });
        };

        window.updateVoucherItemQuantity = (index, newQty) => {
            newQty = parseInt(newQty) || 0;
            if (newQty < 1) return; // Disallow zero/negative quantity

            const newItems = [...state.currentVoucher.items];
            newItems[index].quantity = newQty;

            const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
        };

        window.removeVoucherItem = (index) => {
            const newItems = state.currentVoucher.items.filter((_, i) => i !== index);
            const totalAmount = newItems.reduce((sum, i) => sum + (i.quantity * i.price), 0);
            window.updateState({ currentVoucher: { ...state.currentVoucher, items: newItems, totalAmount } });
        };

        // --- CONFIRMATION MODAL (Replacing window.confirm/alert) ---

        window.showConfirmationModal = (action, type = null) => {
            let message = '';
            let handler = '';
            let buttonText = 'Continue';
            
            if (action === 'scan') {
                message = 'Mobile camera scanning is currently mocked. Enter the barcode manually into the input field above, and press Enter.';
                handler = 'window.closeConfirmationModal()';
                buttonText = 'Got It';
            } else if (action === 'record') {
                if (!state.currentVoucher.partyId) {
                    message = 'Please select a Party before recording the voucher.';
                    handler = 'window.closeConfirmationModal()';
                    buttonText = 'OK';
                } else if (state.currentVoucher.items.length === 0) {
                    message = 'Voucher cannot be empty.';
                    handler = 'window.closeConfirmationModal()';
                    buttonText = 'OK';
                } else {
                    const partyName = state.parties.find(p => p.id === state.currentVoucher.partyId)?.name || 'Unknown Party';
                    message = `Are you sure you want to record this ${type} voucher for Party: ${partyName} with a total of ${getCurrency(state.currentVoucher.totalAmount)}? This will update stock.`;
                    handler = `window.recordVoucherAction('${type}')`;
                    buttonText = `Yes, Record ${type}`;
                }
            }

            updateState({ 
                modalType: 'CONFIRMATION', 
                modalMessage: message, 
                modalHandler: handler,
                modalButtonText: buttonText,
            });
        };

        window.closeConfirmationModal = () => {
            updateState({ modalType: null, modalMessage: null, modalHandler: null, modalButtonText: null });
        };

        window.recordVoucherAction = (type) => {
            window.closeConfirmationModal();
            window.recordVoucher({ 
                ...state.currentVoucher, 
                type: type,
                executiveName: state.user.username,
                totalAmount: state.currentVoucher.totalAmount,
            });
        };
        
        const renderConfirmationModal = () => {
            if (state.modalType !== 'CONFIRMATION') return '';

            return `
                <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div class="tally-panel w-full max-w-sm p-6 space-y-4 text-center">
                        <p class="text-white text-lg">${state.modalMessage}</p>
                        <div class="flex justify-center space-x-4 pt-4">
                            ${state.modalButtonText !== 'OK' && state.modalButtonText !== 'Got It' ? `
                                <button onclick="window.closeConfirmationModal()" class="btn-secondary tally-button">
                                    No, Cancel
                                </button>
                            ` : ''}
                            <button onclick="${state.modalHandler}" class="btn-primary tally-button">
                                ${state.modalButtonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- MAIN RENDER LOOP ---

        const render = () => {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;

            // Main ERP Layout
            let content;
            switch (state.view) {
                case 'DASHBOARD':
                    content = renderDashboard();
                    break;
                case 'INVENTORY':
                    content = renderInventoryMaster();
                    break;
                case 'PARTIES':
                    content = renderPartyMaster();
                    break;
                case 'SALES_VOUCHER':
                    content = renderVoucherEntry('SALES');
                    break;
                case 'PURCHASE_VOUCHER':
                    content = renderVoucherEntry('PURCHASE');
                    break;
                default:
                    content = renderDashboard();
            }

            appContainer.innerHTML = `
                <div class="flex min-h-screen">
                    ${NavMenu()}
                    <div class="flex-1 overflow-auto">
                        ${content}
                    </div>
                </div>
            `;
        };

        // Expose functions globally for HTML event handlers
        window.updateState = updateState;
        window.addUpdateInventoryItem = addUpdateInventoryItem;
        window.addUpdateParty = addUpdateParty;
        window.openInventoryModal = openInventoryModal;
        window.closeInventoryModal = closeInventoryModal;
        window.saveInventoryItem = saveInventoryItem;
        window.openPartyModal = openPartyModal;
        window.closePartyModal = closePartyModal;
        window.saveParty = saveParty;
        window.updateCurrentVoucherParty = updateCurrentVoucherParty;
        window.handleBarcodeInput = handleBarcodeInput;
        window.addItemToVoucher = addItemToVoucher;
        window.updateVoucherItemQuantity = updateVoucherItemQuantity;
        window.removeVoucherItem = removeVoucherItem;
        window.showConfirmationModal = showConfirmationModal;
        window.closeConfirmationModal = closeConfirmationModal;
        window.recordVoucherAction = recordVoucherAction;

        // Initialize App on load
        window.onload = () => {
            loadData();
            render();
        };

    </script>
</head>
<body>
    <!-- Main container for the single-page application -->
    <div id="app-container">
        <!-- Content will be injected here by JavaScript -->
    </div>
</body>
</html>
